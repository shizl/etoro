<?php  
function elessons_permission_node_view($node, $view_mode, $langcode){

   if($node->type=="elesson"){
	
   global $user;

    $account = user_load($user->uid);


	 if(!empty($node->field_elessn_permission['und'][0]['tid']) && $node->field_elessn_permission['und'][0]['tid'] == 19){
	 	$values = array('title'=>'Local Site - Lesson - Page View','username'=>!empty($account->name) ? $account->name:t("normal account"),
                    'source_page_url'=>current_path());
      	mixpanel_track("user_lesson_view", $values);
	 	
	   return true;

	 }elseif(!empty($node->field_permission['und'][0]['tid']) && $node->field_permission['und'][0]['tid'] == 20){
		
		if($user->uid !=0){
			$values = array('title'=>'Local Site - Lesson - Page View','username'=>!empty($account->name) ? $account->name:t("normal account"),
                    'source_page_url'=>current_path());
      		mixpanel_track("user_lesson_view", $values);
			return true;
		}else{
		  drupal_access_denied();
		  exit;
		}
  }elseif(!empty($node->field_permission['und'][0]['tid']) && $node->field_permission['und'][0]['tid'] == 21){
		
   		if(!empty($account->field_practice_account_date['und'][0]['value']) && $account->field_practice_account_date['und'][0]['value']!=''){
   			$values = array('title'=>'Local Site - Lesson - Page View','username'=>!empty($account->name) ? $account->name:t("normal account"),
                    'source_page_url'=>current_path());
      		mixpanel_track("user_lesson_view", $values);
  			return true;
  		}else{
  		  drupal_access_denied();
  		  exit;
  		}

  }elseif(!empty($node->field_permission['und'][0]['tid']) && $node->field_permission['und'][0]['tid'] == 22){

 		if(!empty($account->field_ftd_date['und'][0]['value']) && $account->field_ftd_date['und'][0]['value']!=''){
 			$values = array('title'=>'Local Site - Lesson - Page View','username'=>!empty($account->name) ? $account->name:t("normal account"),
                  'source_page_url'=>current_path());
    		mixpanel_track("user_lesson_view", $values);
		  return true;
		}else{
		  drupal_access_denied();
		  exit;		
		}		
	}else{
	 	   $values = array('title'=>'Local Site - Lesson - Page View',
                    'username'=>!empty($account->name) ? $account->name:t("normal account"),
                    'source_page_url'=>current_path());
      	mixpanel_track("user_lesson_view", $values);
		  return true;
	 }

   }


}


function elessons_permission_block_view_alter(&$data, $block){

if($block->module=='course'){

  switch ($block->delta) {
    case 'outline':
       $data['content'] = overrite_outline();	
    break;
    case 'navigation':
       $data['content'] = overrite_navigation();
    break;
  }
  
 }


}

function overrite_navigation(){
  
  global $user;
  $node = course_get_context();
  if ($node) {
    $course = course_get_course($node, $user, TRUE);
    $links = $course->getNavigation();

    $links['back'] = '<a href="/en/node/'.$node->nid.'">'.t('Back to course').'</a>';
    $items = array();
    foreach($links as $key => $value) {
      $items[] = array(
        'class' => array('course-nav-' . $key),
        'data' => $value,
      );
    }

    // Add javascript poller to update the next step button.
    drupal_add_js(drupal_get_path('module', 'course') . '/js/nav.js', array('cache' => FALSE, 'preprocess' => FALSE));

    return theme('item_list', array('items' => $items, 'title' => NULL, 'type' => 'ul', 'attributes' => array('id' => 'course-nav')));
  }
  
}


function overrite_outline(){

  $node = course_get_context();
  $item = ''; 
  if(isset($node->course['objects'])){
      $num = 1;
    foreach($node->course['objects'] as $courseObject ){
      $lessonid = $courseObject->instance;
      $lesson = node_load($lessonid);

      $time = !empty($lesson->field_time_length['und'][0]['value'])?$lesson->field_time_length['und'][0]['value']:'0';
      $min = Intval($time/60);
      $sec = $time%60;
       $title = '<div class="title">'.t('Lesson').$num.': '.$lesson->title.'</div><div class="time">'.t('Time').': '.$min.t(' minutes ').$sec.t('   seconds').'</div>';
	$uri = !empty($lesson->field_image['und'][0]['uri'])?$lesson->field_image['und'][0]['uri']:'';
	$url = file_create_url($uri);
        $img =  '<img src="'.$url.'">';
	$item .= '<div class="item"><a class="'.($_SERVER['REQUEST_URI']=='/'.$lesson->language.'/'.drupal_get_path_alias('node/'.$lesson->nid)?"active":"").'"  href="/'.$lesson->language.'/'.drupal_get_path_alias('node/' . $lesson->nid).'">'.$img.$title.'</a></div>';
      $num++;

    }
  }
 if($item!=''){
    return '<div id="items">'.$item.'</div><div class="control"><a href="javascript:void(0);" id="prve"><img src="/sites/all/themes/Etoro/images/control_prve.png" /></a> <a href="javascript:void(0);" id="next"><img src="/sites/all/themes/Etoro/images/control_next.png" /></a></div>';
 }else{
    return $item;
 }

}
